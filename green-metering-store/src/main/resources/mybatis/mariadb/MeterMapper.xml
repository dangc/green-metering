<?xml version="1.0" encoding="UTF-8"?>
<!--***********************************
* @Copyright : nuritelecom
* @ProjectName : lwm2m-gateway-store
* @FileName : DeviceMapper.xml
* @Author : jhdang
* @Date : 2021-01
************************************-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuri.green.metering.store.mapper.MeterMapper">

    <sql id="base_where_list">
        <where>
            <if test="locationId != null and locationId != ''" >
                AND a.location_id = #{locationId}
            </if>

            <!--<if test="locationNm != null and locationNm != ''" >
                AND a.location_nm like concat(#{locationNm},'%')
            </if>

            <if test="location1 != null and location1 != ''" >
                AND a.location_1 = #{location1}
            </if>

            <if test="location2 != null and location2 != ''" >
                AND a.location_2 = #{location2}
            </if>-->

            <if test="channel != null and channel != ''" >
                AND a.CHANNEL = #{channel}
            </if>

            <if test="eventCd != null and eventCd != ''" >
                AND a.EVENT_CD = #{eventCd}
            </if>

            <if test="meterId != null" >
                AND a.METER_ID = #{meterId}
            </if>

            <if test="startDate != null and endDate != null" >
                AND a.READ_DT BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
    </sql>

    <sql id="base_where_list_event">
        <where>
            <if test="eventCd != null and eventCd != ''" >
                AND a.EVENT_CD = #{eventCd}
            </if>

            <if test="meterId != null" >
                AND a.METER_ID = #{meterId}
            </if>

            <if test="startDate != null and endDate != null" >
                AND a.EVENT_DT BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
    </sql>

    <sql id="order_by_list">
        <if test="order != null" >
            <foreach collection="order" item="orderby" open="order by" index="index" separator=",">
                ${orderby.sort} ${orderby.dir}
            </foreach>
        </if>
    </sql>

    <sql id="page_limit">
        <if test="page != null" >
            LIMIT #{page.offset}, #{page.limit}
        </if>
    </sql>

    <select id="getLPMeteringByMeter" resultType="lpMeteringByMeterJpo" parameterType="lpMeteringByMeterJpo">
        SELECT
            a.METER_ID as meterId
<!--            , READ_DT as readDt-->
            , ifnull(date_format(a.READ_DT, '%y-%m-%d %H:%i:%s'),'') as readDt
            , a.CHANNEL as channel
            , FNC_GET_CODE_NM(a.CHANNEL) as channelNm
            , a.MESUREMENT_POINT_ID as maeasurementPointId
            , a.METER_SERIAL as meterSerial
            , a.CAPTURED_DIV as captureDiv
            , a.METER_VALUE as meterValue
            , a.METER_VALUE_INTERVAL as meterValueInterval
            , a.METER_STATUS as meterStatus
            , a.LP_INTERVAL as lpInterval
            , a.LOCATION_ID as locationId
            , FNC_GET_LOCATION_NM(a.LOCATION_ID) as locationNm
            , a.APT_NO as aptNo
            , b.APT_NM AS aptNm
            , ifnull(date_format(a.MTIME, '%y-%m-%d %H:%i:%s'),'') as mtime
            , a.ITIME as itime
            , a.DEVICE_ID as deviceId
            , a.DEVICE_SERIAL as deviceSerial
            , a.REG_DT as regDt
            , a.UPDATE_DT as updateDt
        FROM R1.gnd_meter_value a
        LEFT OUTER JOIN gnd_apt_info b ON a.APT_NO = b.APT_NO
        <include refid="base_where_list" />
        <include refid="order_by_list" />
        <include refid="page_limit" />
    </select>

    <select id="getLPMeteringByChannel" resultType="lpMeteringByChannelJpo" parameterType="lpMeteringByChannelJpo">
        SELECT
            meterId
            , readDt
            , maeasurementPointId
            , meterSerial
            , captureDiv
            , MAX(meterValue1) as meterValueCh1
            , MAX(meterValue2) as meterValueCh2
            , MAX(meterValue3) as meterValueCh3
            , MAX(meterValue4) as meterValueCh4
            , MAX(meterValueInterval1) as meterValueIntervalCh1
            , MAX(meterValueInterval2) as meterValueIntervalCh2
            , MAX(meterValueInterval3) as meterValueIntervalCh3
            , MAX(meterValueInterval4) as meterValueIntervalCh4
            , meterStatus
            , lpInterval
            , locationId
            , locationNm
            , aptNo
            , aptNm
            , mtime
            , itime
            , deviceId
            , deviceSerial
        FROM(
                SELECT
                    COUNT(a.CHANNEL),
                    a.METER_ID AS meterId
                    , IFNULL(DATE_FORMAT(a.READ_DT, '%y-%m-%d %H:%i:%s'),'') AS readDt
                    , a.MESUREMENT_POINT_ID AS maeasurementPointId
                    , a.METER_SERIAL AS meterSerial
                    , a.CAPTURED_DIV AS captureDiv
                    , CASE WHEN CHANNEL = 'CH001' THEN a.METER_VALUE ELSE NULL END AS meterValue1
                    , CASE WHEN CHANNEL = 'CH002' THEN a.METER_VALUE ELSE NULL END AS meterValue2
                    , CASE WHEN CHANNEL = 'CH003' THEN a.METER_VALUE ELSE NULL END AS meterValue3
                    , CASE WHEN CHANNEL = 'CH004' THEN a.METER_VALUE ELSE NULL END AS meterValue4
                    , CASE WHEN CHANNEL = 'CH001' THEN a.METER_VALUE_INTERVAL ELSE NULL END AS meterValueInterval1
                    , CASE WHEN CHANNEL = 'CH002' THEN a.METER_VALUE_INTERVAL ELSE NULL END AS meterValueInterval2
                    , CASE WHEN CHANNEL = 'CH003' THEN a.METER_VALUE_INTERVAL ELSE NULL END AS meterValueInterval3
                    , CASE WHEN CHANNEL = 'CH004' THEN a.METER_VALUE_INTERVAL ELSE NULL END AS meterValueInterval4
                    , a.METER_STATUS AS meterStatus
                    , a.LP_INTERVAL AS lpInterval
                    , a.LOCATION_ID AS locationId
                    , FNC_GET_LOCATION_NM(a.LOCATION_ID) AS locationNm
                    , a.APT_NO AS aptNo
                    , b.APT_NM AS aptNm
                    , IFNULL(DATE_FORMAT(a.MTIME, '%y-%m-%d %H:%i:%s'),'') AS mtime
                    , a.ITIME AS itime
                    , a.DEVICE_ID AS deviceId
                    , a.DEVICE_SERIAL AS deviceSerial
                FROM R1.gnd_meter_value a
                LEFT OUTER JOIN gnd_apt_info b ON a.APT_NO = b.APT_NO
                <include refid="base_where_list" />
                GROUP BY
                    a.METER_ID,
                    IFNULL(DATE_FORMAT(a.READ_DT, '%y-%m-%d %H:%i:%s'),''),
                    a.MESUREMENT_POINT_ID, a.METER_SERIAL, a.CAPTURED_DIV
                    , CASE WHEN CHANNEL = 'CH001' THEN a.METER_VALUE ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH002' THEN a.METER_VALUE ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH003' THEN a.METER_VALUE ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH004' THEN a.METER_VALUE ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH001' THEN a.METER_VALUE_INTERVAL ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH002' THEN a.METER_VALUE_INTERVAL ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH003' THEN a.METER_VALUE_INTERVAL ELSE NULL END
                    , CASE WHEN CHANNEL = 'CH004' THEN a.METER_VALUE_INTERVAL ELSE NULL END
                    , a.METER_STATUS, a.LP_INTERVAL, a.LOCATION_ID, FNC_GET_LOCATION_NM(a.LOCATION_ID)
                    , a.APT_NO, b.APT_NM,
                    IFNULL(DATE_FORMAT(a.MTIME, '%y-%m-%d %H:%i:%s'),'')
                    , a.ITIME, a.DEVICE_ID, a.DEVICE_SERIAL
                ORDER BY readDt, channel
        ) A
        GROUP BY
            meterId
            , readDt
            , maeasurementPointId
            , meterSerial
            , captureDiv
            , meterStatus
            , lpInterval
            , locationId
            , locationNm
            , aptNo
            , aptNm
            , mtime
            , itime
            , deviceId
            , deviceSerial
        <include refid="page_limit" />
    </select>

    <select id="getLPMeteringBilling" resultType="lpMeteringBillingJpo" parameterType="lpMeteringBillingJpo">
        SELECT
            a.meter_id
            , a.read_dt
            , a.mesurement_point_id
            , a.meter_serial
            , a.captured_div
            , a.direction
            , a.active_pwr_tot
            , a.apprent_pwr_tot
            , a.lead_pwr_tot
            , a.lagging_pwr_tot
            , a.pf_pwr_tot
            , a.active_pwr_rate1
            , a.apprent_pwr_rate1
            , a.lead_pwr_rate1
            , a.lagging_pwr_rate1
            , a.pf_pwr_rate1
            , a.active_pwr_rate2
            , a.apprent_pwr_rate2
            , a.lead_pwr_rate2
            , a.lagging_pwr_rate2
            , a.pf_pwr_rate2
            , a.active_pwr_rate3
            , a.apprent_pwr_rate3
            , a.lead_pwr_rate3
            , a.lagging_pwr_rate3
            , a.pf_pwr_rate3
            , a.active_pwr_rate4
            , a.apprent_pwr_rate4
            , a.lead_pwr_rate4
            , a.lagging_pwr_rate4
            , a.pf_pwr_rate4
            , a.mtime
            , a.itime
            , a.device_id
            , a.device_serial
            , a.location_id
            , FNC_GET_LOCATION_NM(a.LOCATION_ID) as locationNm
            , a.apt_no
            , b.APT_NM AS aptNm
            , a.reg_dt
            , a.update_dt
        FROM R1.gnd_meter_billing a
        LEFT OUTER JOIN gnd_apt_info b ON a.APT_NO = b.APT_NO
        <include refid="base_where_list" />
        <include refid="order_by_list" />
        <include refid="page_limit" />
    </select>

    <select id="getLPMeteringMonthlyDemand" resultType="lpMeteringMonthlyDemandJpo" parameterType="lpMeteringMonthlyDemandJpo">
        SELECT
            meter_id
            , read_dt
            , mesurement_point_id
            , meter_serial
            , captured_div
            , active_pwr_tot
            , active_pwr_time
            , active_pwr_cum
            , active_pwr_rate1
            , active_pwr_time_rate1
            , active_pwr_cum_rate1
            , active_pwr_rate2
            , active_pwr_time_rate2
            , active_pwr_cum_rate2
            , active_pwr_rate3
            , active_pwr_time_rate3
            , active_pwr_cum_rate3
            , active_pwr_rate4
            , active_pwr_time_rate4
            , active_pwr_cum_rate4
            , apparent_pwr_total
            , apparent_pwr_time
            , apparent_pwr_cum
            , apparent_pwr_rate1
            , apparent_pwr_time_rate1
            , apparent_pwr_cum_rate1
            , apparent_pwr_rate2
            , apparent_pwr_time_rate2
            , apparent_pwr_cum_rate2
            , apparent_pwr_rate3
            , apparent_pwr_time_rate3
            , apparent_pwr_cum_rate3
            , apparent_pwr_rate4
            , apparent_pwr_time_rate4
            , apparent_pwr_cum_rate4
            , mtime
            , itime
            , device_id
            , device_serial
            , location_id
            , FNC_GET_LOCATION_NM(LOCATION_ID) as locationNm
            , apt_no
<!--            , b.APT_NM AS aptNm-->
            , reg_dt
            , update_dt
        FROM R1.gnd_meter_monthly_demand a
        <include refid="base_where_list" />
        <include refid="order_by_list" />
        <include refid="page_limit" />
    </select>

    <select id="getLPMeteringEventLog" resultType="lpMeteringEventLogJpo" parameterType="lpMeteringEventLogJpo">
        SELECT
            event_dt
            , meter_id
            , event_cd
            , meter_serial
            , event_msg
            , device_id
            , device_serial
            , location_id
            , FNC_GET_LOCATION_NM(location_id) as locationNm
            , apt_no
            , reg_dt
            , update_dt
        FROM R1.gnd_meter_event_log a
        <include refid="base_where_list_event" />
        <include refid="order_by_list" />
        <include refid="page_limit" />
    </select>

    <select id="getLPMeteringChannel" resultType="lpMeteringChannelJpo" parameterType="lpMeteringChannelJpo">
        SELECT
            meter_type
            , FNC_GET_CODE_NM(meter_type) as meterTypeNm
            , channel
            , FNC_GET_CODE_NM(channel) as channelNm
            , channel_idx
            , use_yn
        FROM R1.gnd_channel_config a
        WHERE 1=1
        <if test="meterType != null" >
            AND a.METER_TYPE = #{meterType}
        </if>
    </select>

    <select id="getMeterInfo" resultType="lpMeteringChannelJpo" parameterType="java.lang.String">
        SELECT
            meter_type
            , FNC_GET_CODE_NM(meter_type) as meterTypeNm
        FROM R1.gnd_meter_info a
        WHERE 1=1
        <if test="meterId != null" >
            AND a.METER_ID = #{meterId}
        </if>
    </select>

</mapper>